#!/bin/bash
set -e
set -x

FLAGS=(-ldflags '-s -w' -trimpath)
VERSION=$(go run pkg/version/version.go)

function build_for_os64() {
	OUT=ayandict-$VERSION-$1-x86_64
	GOOS=$1 GOARCH=amd64 go build -o $OUT "${FLAGS[@]}"
	echo $OUT
}

function build_for_os32() {
	OUT=ayandict-$VERSION-$1-x86
	GOOS=$1 GOARCH=386 go build -o $OUT "${FLAGS[@]}"
	echo $OUT
}

function build_for_mac() {
	OUT=ayandict-$VERSION-mac-x86_64
	GOOS=darwin GOARCH=amd64 go build -o $OUT "${FLAGS[@]}"
	echo $OUT
}

function run_zip() {
	if [ -f C:\\Windows\\System32\\tar.exe ] ; then
		C:\\Windows\\System32\\tar.exe -a -c -f $1.zip $1
		rm $1
		return
	fi
	if which zip ; then
		zip $1.zip $1
		rm $1
		return
	fi
}

bzip2 -f $(build_for_os64 linux)
bzip2 -f $(build_for_os32 linux)

run_zip $(build_for_os64 windows)
run_zip $(build_for_os32 windows)

bzip2 -f $(build_for_os64 freebsd)
bzip2 -f $(build_for_os32 freebsd)

bzip2 -f $(build_for_mac)

