<!DOCTYPE html>
<html>
<meta charset="utf-8" />

<head>
	<title>AyanDict Web</title>
	<link rel="stylesheet" type="text/css" href="web/style.css" />
	<script type="text/javascript" src="web/brython@3.11.0/brython.min.js">
	</script>
	<script type="text/javascript" src="web/brython@3.11.0/brython_stdlib.js">
	</script>
</head>

<body class="horizontal" onload="brython()">
	<div id="lookup-container" class="vertical">
		<div id="word-container" class="horizontal">
			<input id="lookup-input" name="word" placeholder="Lookup..." type="search" autocomplete="off" autofocus />
			<a id="random-link" href="#">⚅</a>
		</div>
		<div id="result-list"></div>
	</div>

	<div id="content-container" class="vertical">
		<div id="content-header" class="horizontal">
			<span id="header-label"></span>
		</div>
		<div id="content" name="content" class="vertical" style="padding: 20px;"></div>
	</div>
	<script type="text/python">
from browser import document, html, ajax


input = document["lookup-input"]
resultListElem = document["result-list"]
content = document["content"]
headerLabel = document["header-label"]


def is_word_link(target):
	if "://" not in target:
		return True
	if target.startswith("bword://"):
		return True
	return False


def fix_content_word_links():
	for a in content.select('a'):
		target = a.attrs["href"]
		if not is_word_link(target):
			continue
		a.attrs["dict_target"] = target
		a.attrs["href"] = "#"
		a.bind("click", on_word_link_click)


def on_result_row_click(result):
	defi = "<br/>".join(result["definitionsHTML"])
	content.html = defi

	fix_content_word_links()

	headerLabel.clear()
	headerLabel <= html.B(html.FONT(
		result["dictName"],
		color="#55f",
	))
	terms = result["terms"]
	headerLabel <= html.DIV(
		terms[0],
		**{"class": "header-term-first"},
	)
	for term in terms[1:]:
		bar = html.SPAN(
			" │ ",
			**{"class": "header-sep-bar"}
		)
		headerLabel <= html.SPAN(
			bar + term,
			**{"class": "header-term"},
		)


def on_query_result(ajax):
	results = ajax.json
	resultListElem.clear()
	ul = html.UL()
	for index, result in enumerate(results):
		a = html.A(href="#", **{"class": "result-list-item"})
		a.bind("click", lambda event, result=result: on_result_row_click(result))
		a <= html.DIV(html.STRONG(" | ".join(result["terms"])))
		a <= html.SMALL(result["dictName"])
		ul <= html.LI(a)
		if index == 0:
			on_result_row_click(result)
	resultListElem <= ul


def ajax_query(query):
	ajax.post(
		"/query?query=" + query,
		cache=False,
		oncomplete=on_query_result,
	)


def on_lookup_input_keypress(event):
	if event.key != "Enter":
		return
	ajax_query(input.value)


def on_word_link_click(event):
	event.preventDefault()
	a = event.target
	target = a.attrs["dict_target"]
	if target.startswith("bword://"):
		target = target[8:]
	input.value = target
	ajax_query(target)


input.bind("keypress", on_lookup_input_keypress)

	</script>
</body>

</html>
